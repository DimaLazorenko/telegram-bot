name: Run Telegram Bot

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'
  push:
    branches: [ main ]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 9

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install python-telegram-bot[job-queue]==20.7

    - name: Run Bot
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      run: |
        cat > main.py << 'EOF'
        from telegram.ext import *
        from telegram import ReplyKeyboardMarkup
        from datetime import datetime
        import logging
        import time
        import os

        TOKEN = os.environ.get("TELEGRAM_TOKEN")
        
        logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
        logger = logging.getLogger(__name__)

        keyboard = [["â–¶ï¸ Ð¡Ñ‚Ð°Ñ€Ñ‚", "â¸ï¸ ÐŸÐ°ÑƒÐ·Ð°", "â¹ï¸ Ð¡Ñ‚Ð¾Ð¿"], ["ðŸ“ˆ Ð“Ñ€Ð°Ñ„Ð¸Ðº", "ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚"], ["âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸", "ðŸ†˜ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ"]]
        replies = {"â–¶ï¸ Ð¡Ñ‚Ð°Ñ€Ñ‚": "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ", "â¸ï¸ ÐŸÐ°ÑƒÐ·Ð°": "ÐŸÐ°ÑƒÐ·Ð°", "â¹ï¸ Ð¡Ñ‚Ð¾Ð¿": "Ð¡Ñ‚Ð¾Ð¿", "ðŸ“ˆ Ð“Ñ€Ð°Ñ„Ð¸Ðº": "Ð“Ñ€Ð°Ñ„Ð¸Ðº", "ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚": "ÐžÑ‚Ñ‡ÐµÑ‚",
                  "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸": "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸", "ðŸ†˜ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ": "ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ"}

        async def handle(u, c):
            user, text = u.effective_user, u.message.text
            print(f"{datetime.now()} | {user.id} | @{user.username} | {text}")

            if text == "/start":
                await u.message.reply_text("ÐœÐµÐ½ÑŽ:", reply_markup=ReplyKeyboardMarkup(keyboard, True))
            elif text in replies:
                await u.message.reply_text(replies[text])

        def main():
            app = Application.builder().token(TOKEN).build()
            app.add_handler(CommandHandler("start", handle))
            app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle))

            while True:
                try:
                    app.run_polling()
                except Exception as e:
                    logger.error(f"Ð‘Ð¾Ñ‚ ÑƒÐ¿Ð°Ð» Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹: {e}")
                    time.sleep(5)

        if __name__ == "__main__":
            main()
        EOF
        
        python main.py  
